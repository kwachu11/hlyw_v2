{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>Informacje o wydarzeniu</h1>

    <div class="mb-3">
        Wydarzenie w dniu:
        <b>
            {{ event.date.strftime('%d.%m.%Y %H:%M') if event.date.hour != 0 or event.date.minute != 0 else event.date.strftime('%d.%m.%Y') }}
        </b>
    </div>

    <div class="mb-3">
        Tytu≈Ç: <b>{{ event.title }}</b>
    </div>

    <div class="mb-3">
        Opis: <b>{{ event.description }}</b>
    </div>

    <div class="mb-3">
        Organizator: <b>{{ owner.username }}</b>
    </div>

<div class="mb-3">
    <b>Uczestnicy:</b>
    <ul>
        {% if fifa_mode %}
            {% for p in participants_names %}
                <li>
                    {{ p.username }} ‚Äì
                    {% if p.role == "player" %}
                        Gracz ({{ p.club }})
                    {% else %}
                        Obserwator
                    {% endif %}
                </li>
            {% endfor %}
        {% else %}
            {% for p in participants_names %}
                <li>{{ p.username }}</li>
            {% endfor %}
        {% endif %}
    </ul>
</div>

{% if not czy_zapisany %}
    {% if fifa_mode %}
        <!-- Formularz zapisu do turnieju FIFA -->
        <h5>Zapisz siƒô do turnieju FIFA:</h5>
        <form action="{{ url_for('join_fifa_event', event_id=event.id) }}" method="POST" class="mb-3">
            <div class="mb-2">
                <label><b>Rola:</b></label><br>
                <input type="radio" name="role" value="player" required> Gracz
                <input type="radio" name="role" value="observer"> Obserwator
            </div>
            <div class="mb-2" id="club-select" style="display:none;">
                <label for="club"><b>Wybierz klub:</b></label>
                <select name="club" class="form-select">
                    <option value="FC Barcelona">FC Barcelona</option>
                    <option value="Real Madrid">Real Madrid</option>
                    <option value="Manchester United">Manchester United</option>
                    <option value="Liverpool">Liverpool</option>
                    <option value="PSG">PSG</option>
                    <option value="Juventus">Juventus</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Zapisz siƒô</button>
        </form>

        <script>
        // pokazanie wyboru klubu tylko je≈õli gracz
        document.querySelectorAll('input[name="role"]').forEach(el => {
            el.addEventListener('change', function() {
                if (this.value === "player") {
                    document.getElementById('club-select').style.display = 'block';
                } else {
                    document.getElementById('club-select').style.display = 'none';
                }
            });
        });
        </script>
    {% else %}
        <h5>
            Nie jeste≈õ jeszcze zapisany?
            -> <a href="/event?day={{day}}&month={{month}}&year={{year}}&add_user={{current_user.id}}">Zapisz siƒô!</a>
        </h5>
    {% endif %}
{% else %}
    <h5>Jeste≈õ ju≈º zapisany üôÇ</h5>
{% endif %}


    <!-- ======================== TURNIEJ FIFA ======================== -->
    {% if fifa_mode %}
    <hr>
    <h2 class="mt-4">‚öΩ Turniej FIFA</h2>

    {% if current_user.is_admin %}
        <div class="mb-3">
            {% if not tournament %}
                <form action="{{ url_for('start_tournament', event_id=event.id) }}" method="POST">
                    <button type="submit" class="btn btn-primary">üöÄ Rozpocznij turniej</button>
                </form>
            {% elif tournament and tournament.started and not tournament.finished %}
                <form action="{{ url_for('generate_knockout', event_id=event.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-warning">üîÄ Generuj p√≥≈Çfina≈Çy</button>
                </form>
                <form action="{{ url_for('generate_final_route', event_id=event.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-warning">üèÜ Generuj fina≈Ç</button>
                </form>
                <form action="{{ url_for('finish_tournament', event_id=event.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">üèÅ Zako≈Ñcz turniej</button>
                </form>
            {% endif %}
        </div>
    {% endif %}

   {% for group in groups %}
    <h4>Grupa {{ group.name }}</h4>

    <h5>Tabela</h5>
    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Zawodnik</th>
                <th>P</th>
                <th>W</th>
                <th>R</th>
                <th>Pp</th>
                <th>Br+ </th>
                <th>Br- </th>
                <th>+/-</th>
            </tr>
        </thead>
        <tbody>
            {% for row in group.table %}
<tr>
    <td>{{ loop.index }}</td>  {# numer w tabeli, zaczyna od 1 #}
    <td>{{ row.player.username }}</td>
    <td>{{ row.points }}</td>
    <td>{{ row.wins }}</td>
    <td>{{ row.draws }}</td>
    <td>{{ row.losses }}</td>
    <td>{{ row.goals_for }}</td>
    <td>{{ row.goals_against }}</td>
    <td>{{ row.goal_diff }}</td>
</tr>
{% endfor %}
        </tbody>
    </table>

    <!-- Tabela mecz√≥w grupy -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Gospodarz</th>
                <th>Go≈õƒá</th>
                <th>Wynik</th>
                {% if current_user.is_admin %}<th>Akcja</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for match in group.matches %}
            <tr>
                <td>{{ match.home_player.username }}</td>
                <td>{{ match.away_player.username }}</td>
                <td>
                    {% if match.home_score is not none and match.away_score is not none %}
                        {{ match.home_score }} : {{ match.away_score }}
                    {% else %}
                        <span class="text-muted">Brak</span>
                    {% endif %}
                </td>
                {% if current_user.is_admin %}
                <td>
                    <form action="{{ url_for('update_match', match_id=match.id) }}" method="POST" class="d-flex gap-2">
                        <input type="number" name="home_score" class="form-control form-control-sm" style="width:60px" value="{{ match.home_score if match.home_score is not none }}">
                        <input type="number" name="away_score" class="form-control form-control-sm" style="width:60px" value="{{ match.away_score if match.away_score is not none }}">
                        <button type="submit" class="btn btn-success btn-sm">üíæ</button>
                    </form>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}

    {% if semifinals %}
        <h3 class="mt-4">1/2 fina≈Çu</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Gospodarz</th>
                    <th>Go≈õƒá</th>
                    <th>Wynik</th>
                    {% if current_user.is_admin %}<th>Akcja</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for match in semifinals %}
                <tr>
                    <td>{{ match.home_player.username }}</td>
                    <td>{{ match.away_player.username }}</td>
                    <td>
                        {% if match.home_score is not none and match.away_score is not none %}
                            {{ match.home_score }} : {{ match.away_score }}
                        {% else %}
                            <span class="text-muted">Brak</span>
                        {% endif %}
                    </td>
                    {% if current_user.is_admin %}
                    <td>
                        <form action="{{ url_for('update_match', match_id=match.id) }}" method="POST" class="d-flex gap-2">
                            <input type="number" name="home_score" class="form-control form-control-sm" style="width:60px"
                                   value="{{ match.home_score if match.home_score is not none }}">
                            <input type="number" name="away_score" class="form-control form-control-sm" style="width:60px"
                                   value="{{ match.away_score if match.away_score is not none }}">
                            <button type="submit" class="btn btn-success btn-sm">üíæ</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    {% if final %}
        <h3 class="mt-4">Fina≈Ç</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Gospodarz</th>
                    <th>Go≈õƒá</th>
                    <th>Wynik</th>
                    {% if current_user.is_admin %}<th>Akcja</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ final.home_player.username }}</td>
                    <td>{{ final.away_player.username }}</td>
                    <td>
                        {% if final.home_score is not none and final.away_score is not none %}
                            {{ final.home_score }} : {{ final.away_score }}
                        {% else %}
                            <span class="text-muted">Brak</span>
                        {% endif %}
                    </td>
                    {% if current_user.is_admin %}
                    <td>
                        <form action="{{ url_for('update_match', match_id=final.id) }}" method="POST" class="d-flex gap-2">
                            <input type="number" name="home_score" class="form-control form-control-sm" style="width:60px"
                                   value="{{ final.home_score if final.home_score is not none }}">
                            <input type="number" name="away_score" class="form-control form-control-sm" style="width:60px"
                                   value="{{ final.away_score if final.away_score is not none }}">
                            <button type="submit" class="btn btn-success btn-sm">üíæ</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
            </tbody>
        </table>
    {% endif %}

    {% if winner %}
        <div class="alert alert-success mt-4">
            üèÜ ZwyciƒôzcƒÖ turnieju jest <b>{{ winner.username }}</b>!
        </div>
    {% endif %}

    {% endif %}
</div>
{% endblock %}
